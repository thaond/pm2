<?xml version="1.0" encoding="UTF-8"?>

<project name="dbdeploy" default="up.migrate" basedir=".">

    <path id="project.classpath">
        <fileset dir="./lib/">
            <include name="**/*.jar"/>
        </fileset>
    </path>

    <property name="build.outdir" value="./out/db/"/>
    <property name="generated.delta.script.path" location="${build.outdir}/db-deltas-mssql.sql"/>
    <property name="estore.properties.file.path" location="config/estore.properties"/>
    <property file="${estore.properties.file.path}"/>

    <taskdef name="dbdeploy" classname="net.sf.dbdeploy.AntTarget" classpathref="project.classpath"/>


    <macrodef name="exec_sql">
        <attribute name="src"/>
        <attribute name="onerror"/>
        <sequential>
            <sql
                    classpathref="project.classpath"
                    driver="com.microsoft.sqlserver.jdbc.SQLServerDriver"
                    url="${db.url}"
                    userid="${db.username}"
                    password="${db.password}"
                    src="@{src}"
                    onerror="@{onerror}"
                    delimiter="GO"
                    />
        </sequential>
    </macrodef>

    <target name="init">
        <delete dir="${build.outdir}"/>
        <mkdir dir="${build.outdir}"/>
    </target>

    <property name="up" value="999999"/>
    <property name="down" value="0"/>

    <target name="generate.delta.script" description="uses dbdeploy to generate the update and undo scripts">
        <dbdeploy driver="com.microsoft.sqlserver.jdbc.SQLServerDriver" url="${db.url}"
                  userid="${db.username}" password="${db.password}"
                  dir="./db/deltas" outputfile="${generated.delta.script.path}"
                  dbms="mssql" deltaset="DDL" undoOutputfile="${build.outdir}/db-deltas-mssql-UNDO.sql"
                  lastchangetoapply="${up}"/>
    </target>

    <target name="create.db" description="builds the baseline database">
        <exec_sql src="./db/create_schema_version_table.sql" onerror="abort"/>
        <exec_sql src="./db/create_db.sql" onerror="abort"/>
    </target>

    <target name="populate.db" description="populates the baseline database">
        <exec_sql src="./db/populate_db.sql" onerror="continue"/>
    </target>

    <target name="execute.delta.script" description="executes the update script generated by dbdeploy">
        <exec_sql src="${build.outdir}/db-deltas-mssql.sql" onerror="abort"/>
    </target>

    <target name="execute.undo.script" description="executes the undo script generated by dbdeploy">
        <exec_sql src="${build.outdir}/db-deltas-mssql-UNDO.sql" onerror="abort"/>
    </target>

    <target name="update.changelog">
        <sql autocommit="true" classpathref="project.classpath" driver="com.microsoft.sqlserver.jdbc.SQLServerDriver"
             userid="${db.username}"
             password="${db.password}" url="${db.url}" print="true">
            delete from changelog where change_number > ${down};
        </sql>
    </target>

    <target name="create.and.populate.db" depends="init, create.db, populate.db"/>

    <target name="up.migrate" depends="init, generate.delta.script, execute.delta.script"/>

    <target name="down.migrate" depends="init, update.changelog, generate.delta.script, execute.undo.script"/>

    <target name="create.populate.migrate.db" depends="create.and.populate.db, up.migrate"/>

</project>
